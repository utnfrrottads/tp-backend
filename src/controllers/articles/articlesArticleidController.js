import reAssign from '../../utils/reAssign';
import fieldsAllowedByRole from '../../utils/fieldsAllowedByRole';

function articlesArticleidControler(Article) {
  async function findArticleById(req, res, next) {
    try {
      const article = await Article.findById(req.params.articleId)
        .slice('prices', 1)
        .select(fieldsAllowedByRole(req.loggedUser.userRole));

      if (article) {
        req.article = article;
        return next();
      }

      return res.sendStatus(404);
    } catch (err) {
      res.status(503);
      return res.send(err);
    }
  }

  function get(req, res) {
    const { article } = req;

    const returnArticle = article.toJSON();
    if (article.category) {
      const category = encodeURIComponent(article.category.name);
      returnArticle.links = {
        filterByThisCategory: `http://${req.headers.host}/api/articles/?category=${category}`,
      };
    }

    res.json(returnArticle);
  }

  async function put(req, res) {
    if (req.loggedUser.userRole !== 'admin') {
      return res.sendStatus(403);
    }

    const { article } = req;
    reAssign(article, req.body, Article.schema);

    try {
      await article.save();
      return res.json(article);
    } catch (err) {
      res.status(503);
      return res.send(err);
    }
  }

  async function patch(req, res) {
    if (req.loggedUser.userRole !== 'admin') {
      return res.sendStatus(403);
    }

    const { article } = req;

    if (req.body._id) { // eslint-disable-line no-underscore-dangle
      delete req.body._id; // eslint-disable-line no-underscore-dangle
    }
    Object.assign(article, req.body);

    try {
      await article.save();
      return res.json(article);
    } catch (err) {
      res.status(503);
      return res.send(err);
    }
  }

  async function remove(req, res) {
    if (req.loggedUser.userRole !== 'admin') {
      return res.sendStatus(403);
    }

    const { article } = req;

    try {
      await article.remove();
      return res.sendStatus(204);
    } catch (err) {
      res.status(503);
      return res.send(err);
    }
  }

  return {
    findArticleById,
    get,
    put,
    patch,
    remove,
  };
}

module.exports = articlesArticleidControler;
